(function(f){function escapeRegEx(a){return a.replace(/([.*+?^=!:${}()|[\]\/\\])/g,'\\$1')}function isArray(a){return String(Object.prototype.toString.call(a))==="[object Array]"}function filterArrayValues(a,b){var c={},i,length;if(isArray(b)){for(i=0,length=b.length;i<length;i++){c[b[i]]=true}}else{c[b]=true}for(i=0,length=a.length;i<length;i++){if(c[a[i]]!==f){a.splice(i,1);length--;i--}}return a}var g=function(a,b){if(!(this instanceof g)){return new g(a)}if(a===f){a=location.href+""}this.href(a);if(b!==f){return this.absoluteTo(b)}return this},p=g.prototype;g.idn_expression=/[^a-z0-9\.-]/i;g.punycode_expression=/(xn--)/i;g.ip4_expression=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/;g.ip6_expression=/^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*$/;g.find_uri_expression=/\b((?:[a-z][\w-]+:(?:\/{1,3}|[a-z0-9%])|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/ig;g.defaultPorts={http:"80",https:"443",ftp:"21"};g.encode=encodeURIComponent;g.decode=decodeURIComponent;g.characters={pathname:{encode:{expression:/%(24|26|2B|2C|3B|3D|3A|40)/ig,map:{"%24":"$","%26":"&","%2B":"+","%2C":",","%3B":";","%3D":"=","%3A":":","%40":"@"}},decode:{expression:/[\/\?#]/g,map:{"/":"%2F","?":"%3F","#":"%23"}}}};g.encodeQuery=function(a){return encodeURIComponent(a+"").replace(/%20/g,'+')};g.decodeQuery=function(a){return decodeURIComponent((a+"").replace(/\+/g,'%20'))};g.recodePath=function(a){var b=(a+"").split('/');for(var i=0,length=b.length;i<length;i++){b[i]=g.encodePathSegment(g.decode(b[i]))}return b.join('/')};g.decodePath=function(a){var b=(a+"").split('/');for(var i=0,length=b.length;i<length;i++){b[i]=g.decodePathSegment(b[i])}return b.join('/')};var h={'encode':'encode','decode':'decode'},_part;for(_part in h){g[_part+"PathSegment"]=(function(b){return function(a){return window[b+'URIComponent'](a+"").replace(g.characters.pathname[b].expression,function(c){return g.characters.pathname[b].map[c]})}})(h[_part])}g.parse=function(a){var b,t,parts={};b=a.indexOf('#');if(b>-1){parts.fragment=a.substring(b+1)||null;a=a.substring(0,b)}b=a.indexOf('?');if(b>-1){parts.query=a.substring(b+1)||null;a=a.substring(0,b)}b=a.indexOf('://');if(b>-1){parts.protocol=a.substring(0,b);a=a.substring(b+3);a=g.parseAuthority(a,parts)}parts.path=a;return parts};g.parseHost=function(a,b){var c=a.indexOf('/');if(c===-1){c=a.length}if(a[0]==="["){var d=a.indexOf(']');b.hostname=a.substring(1,d)||null;b.port=a.substring(d+2,c)||null}else if(a.indexOf(':')!==a.lastIndexOf(':')){b.hostname=a.substring(0,c)||null;b.port=null}else{t=a.substring(0,c).split(':');b.hostname=t[0]||null;b.port=t[1]||null}if(b.hostname&&a.substring(c)[0]!=='/'){c++;a="/"+a}return a.substring(c)||'/'};g.parseAuthority=function(a,b){var c=a.indexOf('@'),firstSlash=a.indexOf('/');if(c>-1&&(firstSlash===-1||c<firstSlash)){t=a.substring(0,c).split(':');b.username=t[0]?g.decode(t[0]):null;b.password=t[1]?g.decode(t[1]):null;a=a.substring(c+1)}else{b.username=null;b.password=null}return g.parseHost(a,b)};g.parseQuery=function(a){if(!a){return{}}a=a.replace(/&+/g,'&').replace(/^\?*&*|&+$/g,'');if(!a){return{}}var b={},splits=a.split('&'),length=splits.length;for(var i=0;i<length;i++){var v=splits[i].split('='),name=g.decodeQuery(v.shift()),value=v.length?g.decodeQuery(v.join('=')):null;if(b[name]){if(typeof b[name]==="string"){b[name]=[b[name]]}b[name].push(value)}else{b[name]=value}}return b};g.build=function(a){var t='';if(typeof a.protocol==="string"&&a.protocol.length){t+=a.protocol+"://"}t+=(g.buildAuthority(a)||'');if(typeof a.path==="string"){if(a.path[0]!=='/'&&typeof a.hostname==="string"){t+='/'}t+=a.path}if(typeof a.query=="string"){t+='?'+a.query}if(typeof a.fragment==="string"){t+='#'+a.fragment}return t};g.buildHost=function(a){var t='';if(!a.hostname){return''}else if(g.ip6_expression.test(a.hostname)){if(a.port){t+="["+a.hostname+"]:"+a.port}else{t+=a.hostname}}else{t+=a.hostname;if(a.port){t+=':'+a.port}}return t};g.buildAuthority=function(a){var t='';if(a.username){t+=g.encode(a.username);if(a.password){t+=':'+g.encode(a.password)}t+="@"}t+=g.buildHost(a);return t};g.buildQuery=function(a,b){var t="";for(var c in a){if(Object.hasOwnProperty.call(a,c)&&c){if(isArray(a[c])){var d={};for(var i=0,length=a[c].length;i<length;i++){if(a[c][i]!==f&&d[a[c][i]+""]===f){t+="&"+g.buildQueryParameter(c,a[c][i]);if(b!==true){d[a[c][i]+""]=true}}}}else if(a[c]!==f){t+='&'+g.buildQueryParameter(c,a[c])}}}return t.substring(1)};g.buildQueryParameter=function(a,b){return g.encodeQuery(a)+(b!==null?"="+g.encodeQuery(b):"")};g.addQuery=function(a,b,c){if(typeof b==="object"){for(var d in b){if(Object.prototype.hasOwnProperty.call(b,d)){g.addQuery(a,d,b[d])}}}else if(typeof b==="string"){if(a[b]===f){a[b]=c;return}else if(typeof a[b]==="string"){a[b]=[a[b]]}if(!isArray(c)){c=[c]}a[b]=a[b].concat(c)}else{throw new TypeError("URI.addQuery() accepts an object, string as the name parameter");}};g.removeQuery=function(a,b,c){if(isArray(b)){for(var i=0,length=b.length;i<length;i++){a[b[i]]=f}}else if(typeof b==="object"){for(var d in b){if(Object.prototype.hasOwnProperty.call(b,d)){g.removeQuery(a,d,b[d])}}}else if(typeof b==="string"){if(c!==f){if(a[b]===c){a[b]=f}else if(isArray(a[b])){a[b]=filterArrayValues(a[b],c)}}else{a[b]=f}}else{throw new TypeError("URI.addQuery() accepts an object, string as the first parameter");}};g.commonPath=function(a,b){var c=Math.min(a.length,b.length),pos;for(pos=0;pos<c;pos++){if(a[pos]!==b[pos]){pos--;break}}if(pos<1){return a[0]===b[0]&&a[0]==='/'?'/':''}if(a[pos]!=='/'){pos=a.substring(0,pos).lastIndexOf('/')}return a.substring(0,pos+1)};g.withinString=function(a,b){return a.replace(g.find_uri_expression,b)};p.build=function(a){if(a===true){this._deferred_build=true}else if(a===f||this._deferred_build){this._string=g.build(this._parts);this._deferred_build=false}return this};p.toString=function(){return this.build(false)._string};p.valueOf=function(){return this.toString()};h={protocol:'protocol',username:'username',password:'password',hostname:'hostname',port:'port'};for(_part in h){p[_part]=(function(b){return function(v,a){if(v===f){return this._parts[b]||""}else{this._parts[b]=v;this.build(!a);return this}}})(h[_part])}h={query:'?',fragment:'#'};for(_part in h){p[_part]=(function(b,c){return function(v,a){if(v===f){return this._parts[b]||""}else{if(v!==null){v=v+"";if(v[0]===c){v=v.substring(1)}}this._parts[b]=v;this.build(!a);return this}}})(_part,h[_part])}h={search:['?','query'],hash:['#','fragment']};for(_part in h){p[_part]=(function(b,c){return function(v,a){var t=this[b](v,a);return typeof t==="string"&&t.length?(c+t):t}})(h[_part][1],h[_part][0])}p.pathname=function(v,a){if(v===f||v===true){var b=this._parts.path||"/";return v?g.decodePath(b):b}else{this._parts.path=v?g.recodePath(v):"/";this.build(!a);return this}};p.path=p.pathname;p.href=function(a,b){if(a===f){return this.toString()}else{this._string="";this._parts={protocol:null,username:null,password:null,hostname:null,port:null,path:null,query:null,fragment:null};var c=a instanceof g,_object=typeof a==="object"&&(a.hostname||a.path),key;if(typeof a==="string"){this._parts=g.parse(a)}else if(c||_object){var d=c?a._parts:a;for(key in d){if(Object.hasOwnProperty.call(this._parts,key)){this._parts[key]=d[key]}}}else{throw new TypeError("invalid input");}this.build(!b);return this}};p.is=function(a){var b=false,ip4=false,ip6=false,name=false,idn=false,punycode=false,relative=true;if(this._parts.hostname){relative=false;ip4=g.ip4_expression.test(this._parts.hostname);ip6=g.ip6_expression.test(this._parts.hostname);b=ip4||ip6;name=!b;idn=name&&g.idn_expression.test(this._parts.hostname);punycode=name&&g.punycode_expression.test(this._parts.hostname)}switch(a.toLowerCase()){case'relative':return relative;case'domain':case'name':return name;case'ip':return b;case'ip4':case'ipv4':case'inet4':return ip4;case'ip6':case'ipv6':case'inet6':return ip6;case'idn':return idn;case'punycode':return punycode}return null};p.host=function(v,a){if(v===f){return this._parts.hostname?g.buildHost(this._parts):""}else{g.parseHost(v,this._parts);this.build(!a);return this}};p.authority=function(v,a){if(v===f){return this._parts.hostname?g.buildAuthority(this._parts):""}else{g.parseAuthority(v,this._parts);this.build(!a);return this}};p.subdomain=function(v,a){if(v===f){if(!this._parts.hostname||this.is('IP')){return""}var b=this._parts.hostname.length-this.domain().length-1;return this._parts.hostname.substring(0,b)||""}else{var e=this._parts.hostname.length-this.domain().length,sub=this._parts.hostname.substring(0,e),replace=new RegExp('^'+escapeRegEx(sub));if(v&&v[v.length-1]!=='.'){v+="."}this._parts.hostname=this._parts.hostname.replace(replace,v);this.build(!a);return this}};p.domain=function(v,a){if(v===f){if(!this._parts.hostname||this.is('IP')){return""}return this._parts.hostname.match(/\.?([^\.]+\.[^\.]+)$/)[1]||this._parts.hostname}else{if(!v){throw new TypeError("cannot set domain empty");}else if(!this._parts.hostname||this.is('IP')){this._parts.hostname=v}else{var b=new RegExp(escapeRegEx(this.domain())+"$");this._parts.hostname=this._parts.hostname.replace(b,v)}this.build(!a);return this}};p.tld=function(v,a){if(v===f){if(!this._parts.hostname||this.is('IP')){return""}var b=this._parts.hostname.lastIndexOf('.');return this._parts.hostname.substring(b+1)}else{if(!v){throw new TypeError("cannot set TLD empty");}else if(!this._parts.hostname||this.is('IP')){throw new ReferenceError("cannot set TLD on non-domain host");}else{var c=new RegExp(escapeRegEx(this.tld())+"$");this._parts.hostname=this._parts.hostname.replace(c,v)}this.build(!a);return this}};p.directory=function(v,a){if(v===f||v===true){if(!this._parts.path||this._parts.path==='/'){return'/'}var b=this._parts.path.length-this.filename().length-1,res=this._parts.path.substring(0,b)||"/";return v?g.decodePath(res):res}else{var e=this._parts.path.length-this.filename().length,directory=this._parts.path.substring(0,e),replace=new RegExp('^'+escapeRegEx(directory));if(!this.is('relative')){if(!v){v='/'}if(v[0]!=='/'){v="/"+v}}if(v&&v[v.length-1]!=='/'){v+='/'}v=g.recodePath(v);this._parts.path=this._parts.path.replace(replace,v);this.build(!a);return this}};p.filename=function(v,a){if(v===f||v===true){if(!this._parts.path||this._parts.path==='/'){return""}var b=this._parts.path.lastIndexOf('/'),res=this._parts.path.substring(b+1);return v?g.decodePathSegment(res):res}else{if(v[0]==='/'){v=v.substring(1)}var c=new RegExp(escapeRegEx(this.filename())+"$");v=g.recodePath(v);this._parts.path=this._parts.path.replace(c,v);this.build(!a);return this}};p.suffix=function(v,a){if(v===f||v===true){if(!this._parts.path||this._parts.path==='/'){return""}var b=this.filename(),pos=b.lastIndexOf('.'),s;if(pos===-1){return""}s=b.substring(pos+1);res=(/^[a-z0-9%]+$/i).test(s)?s:"";return v?g.decodePathSegment(res):res}else{if(v[0]==='.'){v=v.substring(1)}var c=this.suffix(),replace;if(!c){if(!v){return this}this._parts.path+='.'+g.recodePath(v)}else if(!v){replace=new RegExp(escapeRegEx("."+c)+"$")}else{replace=new RegExp(escapeRegEx(c)+"$")}if(replace){v=g.recodePath(v);this._parts.path=this._parts.path.replace(replace,v)}this.build(!a);return this}};var q=p.query;p.query=function(v,a){if(v===true){return g.parseQuery(this._parts.query)}else if(v!==f&&typeof v!=="string"){this._parts.query=g.buildQuery(v);this.build(!a);return this}else{return q.call(this,v,a)}};p.addQuery=function(a,b,c){var d=g.parseQuery(this._parts.query);g.addQuery(d,a,b);this._parts.query=g.buildQuery(d);if(typeof a!=="string"){c=b}this.build(!c);return this};p.removeQuery=function(a,b,c){var d=g.parseQuery(this._parts.query);g.removeQuery(d,a,b);this._parts.query=g.buildQuery(d);if(typeof a!=="string"){c=b}this.build(!c);return this};p.addSearch=p.addQuery;p.removeSearch=p.removeQuery;p.normalize=function(){return this.normalizeProtocol(false).normalizeHostname(false).normalizePort(false).normalizePath(false).normalizeQuery(false).normalizeFragment(false).build()};p.normalizeProtocol=function(a){if(typeof this._parts.protocol==="string"){this._parts.protocol=this._parts.protocol.toLowerCase();this.build(!a)}return this};p.normalizeHostname=function(a){if(this._parts.hostname){if(this.is('IDN')&&window.punycode){this._parts.hostname=punycode.toASCII(this._parts.hostname)}else if(this.is('IPv6')&&window.IPv6){this._parts.hostname=IPv6.best(this._parts.hostname)}this._parts.hostname=this._parts.hostname.toLowerCase();this.build(!a)}return this};p.normalizePort=function(a){if(typeof this._parts.protocol==="string"&&this._parts.port===g.defaultPorts[this._parts.protocol]){this._parts.port=null;this.build(!a)}return this};p.normalizePath=function(a){if(!this._parts.path||this._parts.path==='/'){return this}var b,_was_relative_prefix,_path=this._parts.path,_parent,_pos;if(_path[0]!=='/'){if(_path[0]==='.'){_was_relative_prefix=_path.substring(0,_path.indexOf('/'))}b=true;_path='/'+_path}_path=_path.replace(/(\/(\.\/)+)|\/{2,}/g,'/');while(true){_parent=_path.indexOf('/../');if(_parent===-1){break}else if(_parent===0){_path=_path.substring(3);break}_pos=_path.substring(0,_parent).lastIndexOf('/');if(_pos===-1){_pos=_parent}_path=_path.substring(0,_pos)+_path.substring(_parent+3)}if(b&&this.is('relative')){if(_was_relative_prefix){_path=_was_relative_prefix+_path}else{_path=_path.substring(1)}}_path=g.recodePath(_path);this._parts.path=_path;this.build(!a);return this};p.normalizePathname=p.normalizePath;p.normalizeQuery=function(a){if(typeof this._parts.query==="string"){if(!this._parts.query.length){this._parts.query=null}else{this.query(g.parseQuery(this._parts.query))}this.build(!a)}return this};p.normalizeFragment=function(a){if(!this._parts.fragment){this._parts.fragment=null;this.build(!a)}return this};p.normalizeSearch=p.normalizeQuery;p.normalizeHash=p.normalizeFragment;p.readable=function(){var a=new g(this);a.username("").password("").normalize();var t='';if(a._parts.protocol){t+=a._parts.protocol+'://'}if(a._parts.hostname){if(a.is('punycode')&&window.punycode){t+=punycode.toUnicode(a._parts.hostname);if(a._parts.port){t+=":"+a._parts.port}}else{t+=a.host()}}if(a._parts.hostname&&a._parts.path&&a._parts.path[0]!=='/'){t+='/'}t+=a.path(true);if(a._parts.query){var q='';for(var i=0,qp=a._parts.query.split('&'),l=qp.length;i<l;i++){var b=(qp[i]||"").split('=');q+='&'+g.decodeQuery(b[0]).replace(/&/g,'%26');if(b[1]!==f){q+="="+g.decodeQuery(b[1]).replace(/&/g,'%26')}}t+='?'+q.substring(1)}t+=a.hash();return t};p.absoluteTo=function(a){if(!this.is('relative')){throw new Error('Cannot resolve non-relative URL');}if(!(a instanceof g)){a=new g(a)}var b=new g(this),properties=['protocol','username','password','hostname','port'];for(var i=0,p;p=properties[i];i++){b._parts[p]=a._parts[p]}if(b.path()[0]!=='/'){b._parts.path=a.directory()+'/'+b._parts.path;b.normalizePath()}b.build();return b};p.relativeTo=function(a){if(!(a instanceof g)){a=new g(a)}if(this.path()[0]!=='/'||a.path()[0]!=='/'){throw new Error('Cannot calculate common path from non-relative URLs');}var b=new g(this),properties=['protocol','username','password','hostname','port'],common=g.commonPath(b.path(),a.path()),_base=a.directory();for(var i=0,p;p=properties[i];i++){b._parts[p]=null}if(!common||common==='/'){return b}if(_base+'/'===common){b._parts.path='./'+b.filename()}else{var c='../',_common=new RegExp('^'+escapeRegEx(common)),_parents=_base.replace(_common,'/').match(/\//g).length-1;while(_parents--){c+='../'}b._parts.path=b._parts.path.replace(_common,c)}b.build();return b};p.equals=function(a){var b=new g(this),two=new g(a),one_map={},two_map={},checked={},one_query,two_query,key;b.normalize();two.normalize();if(b.toString()===two.toString()){return true}one_query=b.query();two_query=two.query();b.query("");two.query("");if(b.toString()!==two.toString()){return false}if(one_query.length!==two_query.length){return false}one_map=g.parseQuery(one_query);two_map=g.parseQuery(two_query);for(key in one_map){if(Object.prototype.hasOwnProperty.call(one_map,key)){if(!isArray(one_map[key])){if(one_map[key]!==two_map[key]){return false}}else{if(!isArray(two_map[key])){return false}if(one_map[key].length!==two_map[key].length){return false}one_map[key].sort();two_map[key].sort();for(var i=0,l=one_map[key].length;i<l;i++){if(one_map[key][i]!==two_map[key][i]){return false}}}checked[key]=true}}for(key in two_map){if(Object.prototype.hasOwnProperty.call(two_map,key)){if(!checked[key]){return false}}}return true};window.URI=g})();